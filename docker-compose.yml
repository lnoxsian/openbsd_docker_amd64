version: "3.8"

services:
  openbsd-kvm:
    build: ./openbsd_docker_amd64
    image: openbsd_docker_amd64:latest
    container_name: openbsd-kvm
    devices:
      - /dev/kvm:/dev/kvm
    security_opt:
      - seccomp:unconfined
    volumes:
      - ./images:/images
    ports:
      # noVNC web UI (container NOVNC_PORT; host maps HOST_VNC_PORT)
      - "${HOST_VNC_PORT:-6080}:${NOVNC_PORT:-6080}"
      # Optional: expose container's raw VNC TCP port (5901). Only needed if you want
      # to use a native VNC client to connect directly to the container.
      - "${HOST_VNC_RAW_PORT:-5901}:${HOST_VNC_RAW_PORT:-5901}"
      # SSH forwarding via QEMU's user-net hostfwd (only if HOST_SSH_PORT set)
      - "${HOST_SSH_PORT:-2222}:${HOST_SSH_PORT:-2222}"
    environment:
      # Firmware selection: "legacy" (BIOS) or "uefi" (OVMF). Default: legacy
      FIRMWARE: "legacy"

      # Boot mode: "install" = boot the installer ISO, "boot" = boot the qcow2 disk image
      BOOT_MODE: "install"

      # If provided, the container will download this ISO to /images/install.iso
      # Example: https://cdn.openbsd.org/pub/OpenBSD/7.4/amd64/install74.iso
      OPENBSD_ISO_URL: ""

      # Files and sizes inside ./images (host path mounted to /images)
      ISO_NAME: "install.iso"
      DISK_NAME: "disk.qcow2"
      DISK_SIZE: "20G"

      # QEMU VM resources
      MEMORY: "2048"       # MB
      CORES: "2"

      # Networking / VNC
      HOST_SSH_PORT: "2222"
      GRAPHICAL: "true"     # "true" to enable VNC + noVNC; "false" to use serial console
      VNC_DISPLAY: "1"      # QEMU VNC display number (1 -> TCP 5901)
      NOVNC_PORT: "6080"    # Port noVNC web UI listens on inside container
      HOST_VNC_PORT: "6080" # Host port mapped to NOVNC_PORT
      HOST_VNC_RAW_PORT: "5901" # Host raw VNC port (optional)
    restart: unless-stopped
